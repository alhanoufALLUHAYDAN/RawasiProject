{% extends 'main/base.html'%}
{%load static%}
{%block title%}<title>لوحة التحكم - المستثمر</title>{%endblock%}
{%block head%}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" type="text/css" href="{% static 'css/main.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  background-image: url("/static/images/Background.png");
  background-size: cover;
}
</style>
{%endblock%}
{%block content%}
<section class="container rounded-3 dashboard shadow">
  <div class="row dashboard-row">
      <!-- Sidebar -->
      <div class="col-md-3 p-3 d-flex flex-column justify-content-between dashboard-side">
        <div>
          <h4 class=" mb-4 text-center ">مرحبا <span>{{investor.full_name}}</span></h4>
          <ul class="nav flex-column dashboard-links">
              <li class="nav-item">
               
                
                <a class="nav-link-dashboard active" href="#" data-content="section1">
                  <i class="fa-solid fa-boxes-stacked"></i>
                  <span class="px-2">الصناديق</span> 
                </a>

              </li>
              <li class="nav-item">
                  <a class="nav-link-dashboard" href="#" data-content="section2">
                    <i class="fa-solid fa-bullhorn"></i>
                    <span class="px-2">التصويت</span> 
                  </a>
              </li>
              <li class="nav-item">
                  <a class="nav-link-dashboard" href="#" data-content="section3">
                    <i class="fa-solid fa-coins"></i>
                    <span class="px-2">الأرباح</span> 
                  </a>
              </li>
              <li class="nav-item">
                  <a class="nav-link-dashboard" href="#" data-content="section4">
                    <i class="fa-solid fa-wallet"></i>
                    <span class="px-2">المحفظة</span> 
                  </a>
              </li>
              <li class="nav-item">
                  <a class="nav-link-dashboard" href="#" data-content="section5">
                    <i class="fa-regular fa-address-card"></i>
                    <span class="px-2">حسابي</span> 
                  </a>
              </li>
          </ul>
        </div>
        <div class="d-flex justify-content-center">
      <button class="btn btn-darkgreen" data-bs-toggle="modal" data-bs-target="#codeModal">
        انضمام   </button>
          <!-- Modal Structure -->
          <div class="modal fade" id="codeModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              
              <div class="modal-content">
                <div class="modal-header border-white d-flex justify-content-between">
                    <h5 class="modal-title" id="exampleModalLabel">الرمز</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="{%url 'main:investor_dashboard_view'%}">
                        {% csrf_token %}
                        <input type="text" name="join_code" maxlength="10" class="form-control" placeholder="أدخل رمز الانضمام" required/>
                        <div class="modal-footer border-white">
                            <button type="submit" class="btn btn-darkgreen">ارسال</button>
                        </div>
                    </form>
                </div>
            </div>
            </div>
        </div>
        </div>
    </div>
    <!-- Content Area -->
    <div class="col-md-9 p-3">
        {% if messages %}
        {% for message in messages %}
        {% if not request.session.show_message or message.tags != request.session.show_message %}
        <div class=" w-100">
            <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-success{% endif %} w-100 d-flex justify-content-between align-items-center" role="alert">
                {{ message }}
            <button type="button" class="btn-close m-0 px-2" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
            </div>
            {% endif %}
        {% endfor %}
      {% endif %}
      <div id="section1" class="dashboard-section">
        <div class="container mt-5">
            <!-- Investor Dashboard Header -->
            <h4 class="text-center">صناديق الاستثمار التي انضممت إليها</h4>
            <div class="p-4 mt-4 bg-white shadow-sm rounded">
            <table class="table table-striped text-center">
                <thead>
                    <tr>
                        <th>اسم الصندوق</th>
                        <th>المبلغ المستثمر</th>
                        <th>الأرباح</th>
                    </tr>
                </thead>
                <tbody>
                    {% for fund in profit_data %}
                        <tr>
                            <td>{{ fund.fund_name }}</td>
                            <td>{{ fund.amount_invested }} ريال</td>
                            <td>{{ fund.profit }} ريال</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="3">لا توجد صناديق استثمار للعرض.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="row mt-4">
            <div class="col-md-12">

                <canvas id="fundsChart" width="100%" height="50%"></canvas>
            </div>
        </div>
        </div>            
    </div>
    
    <!-- التصويت-->
<div id="section2" class="dashboard-section container" style="display: none;">
    {% if opportunities %}
    <div class="d-flex align-items-end justify-content-end">
        <button class="btn btn-darkgreen" data-bs-toggle="modal" data-bs-target="#votingModal">
            إضافة تصويت جديد <i class="fa-solid fa-plus"></i>
        </button>
    </div>
    
  
  <div class="modal fade" id="votingModal" tabindex="-1" aria-labelledby="votingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header d-flex justify-content-between p-0 px-3 py-2">
            <h5 class="modal-title" id="votingModalLabel">إضافة تصويت جديد</h5>
            <button type="button" class="btn-close m-0 p-0" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <form method="POST" action="{% url 'investments:add_voting' %}" enctype="multipart/form-data">
                {% csrf_token %}
  
                <div class="mb-3">
                    <label for="opportunity" class="form-label" style="color: #761305;">اختَر الفرصة الاستثمارية</label>
                    <select class="form-select" id="opportunity" name="opportunity" required>
                        <option value="">-- اختر الفرصة --</option>
                        {% for opportunity in opportunities %}
                            <option value="{{ opportunity.id }}">{{ opportunity.title }}</option>
                        {% endfor %}
                    </select>
                </div>
    
                <div class="mb-3">
                    <label for="vote_type" class="form-label" style="color: #761305;">نوع التصويت</label>
                    <label class="form-control" style="background-color: #f1f1f1;">شراء</label>
                    <input type="hidden" name="vote_type" value="buy">
                </div>
    
                <div class="mb-3">
                    <label for="required_approval_percentage" class="form-label" style="color: #761305;">النسبة المطلوبة للموافقة</label>
                    <input type="number" class="form-control" id="required_approval_percentage" name="required_approval_percentage" required min="0" max="100">
                </div>
    
                <div class="mb-3">
                    <label for="voting_start_time" class="form-label" style="color: #761305;">تاريخ بداية التصويت</label>
                    <input type="datetime-local" class="form-control" id="voting_start_time" name="voting_start_time" required>
                </div>
    
                <div class="mb-3">
                    <label for="voting_end_time" class="form-label" style="color: #761305;">تاريخ نهاية التصويت</label>
                    <input type="datetime-local" class="form-control" id="voting_end_time" name="voting_end_time" required>
                </div>
    
    
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                    <button type="submit" class="btn btn-darkgreen">إضافة التصويت</button>
                </div>
            </form>
        </div>
    </div>
  </div>
  </div>
  <div class="row my-2 ">
    {% for opportunity in opportunities %}
    <div class="card mb-3">
        <div class="card-body container">
          <div class="row">
            <div class="col-md-6">
              <h5 class="card-title" style="color: #761305;">{{ opportunity.title }}</h5>
              <p class="card-text"><strong>المبلغ الإجمالي:</strong> {{ opportunity.total_investment }} ريال</p>
              <p class="card-text"><strong>العائد المتوقع:</strong> {{ opportunity.expected_return }}%</p>
              <p class="card-text"><strong>تاريخ البداية:</strong> {{ opportunity.start_date|date:"Y-m-d" }}</p>
              <p class="card-text"><strong>تاريخ الانتهاء:</strong> {{ opportunity.end_date|date:"Y-m-d" }}</p>
    
            </div>
            <div class="col-md-6">
              <p class="card-text"><strong>النسبة المطلوبة للموافقة:</strong> {{ opportunity.required_approval_percentage }}%</p>
              <p class="card-text"><strong>نسبة الموافقه:</strong> {{ opportunity.approval_percentage }}%</p>
              <p class="card-text"><strong>قبول :</strong> {{ opportunity.accepted_votes }}</p>
              <p class="card-text"><strong>رفض :</strong> {{ opportunity.rejected_votes }}</p>
    
            </div>
          </div>
  
            <p class="card-text">
                {% if opportunity.status == 'Closed' %}
                    <span class="badge bg-dark">تم إغلاق التصويت</span>
                {% elif opportunity.status == 'Open' %}
                    {% if opportunity.pending_votes > 0 %}
                        <span class="badge bg-warning">التصويت قيد الانتظار</span>
                    {% else %}
                        <span class="badge bg-success">التصويت مكتمل</span>
                    {% endif %}
                {% elif opportunity.status == 'Not Started' %}
                    <span class="badge bg-secondary">لم يتم بدء التصويت</span> 
                {% endif %}
            </p>
  
            <div class="d-flex justify-content-between ">
              <div class="d-flex flex-column align-items-end justify-content-end "> 
                <a href="{% url 'investments:investment_opportunity_detail' id=opportunity.id %}" class="btn btn-darkgreen">تفاصيل الفرصة</a>
              </div>
  
                {% if opportunity.status == 'Open' and user_investor %}
                    <form method="POST" action="{% url 'investments:vote_on_opportunity' id=opportunity.id %}">
                        {% csrf_token %}
                        <button type="submit" name="vote_choice" value="Accepted" class="btn btn-success">أوافق</button>
                        <button type="submit" name="vote_choice" value="Rejected" class="btn btn-danger">أرفض</button>
                    </form>
                {% elif opportunity.status == 'Closed' %}
               
          
                {% endif %}
  
            </div>
        </div>
    </div>
    {% endfor %}
  </div>
    <br/>
    <navbar aria-label="Page navigation example">
        <ul class="pagination justify-content-center gap-4">
            {% if opportunities.has_next %}
                <li class="page-item">
                    <a class="page-link rounded-3 px-3 py-2" href="?page={{ opportunities.next_page_number }}&section=section2" aria-label="Next">
                        <span aria-hidden="true"><i class="fa-solid fa-chevron-right"></i></span>
                    </a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link rounded-3 px-3 py-2" aria-hidden="true"><i class="fa-solid fa-chevron-right"></i></span>
                </li>
            {% endif %}
  
            {% if opportunities.has_previous %}
            <li class="page-item">
                <a class="page-link rounded-3 px-3 py-2" href="?page={{ opportunities.previous_page_number }}&section=section2" aria-label="Previous">
                    <span aria-hidden="true"><i class="fa-solid fa-chevron-left"></i></span>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link rounded-3 px-3 py-2" aria-hidden="true"><i class="fa-solid fa-chevron-left"></i></span>
            </li>
            {% endif %}
        </ul>
    </navbar>
    {% else %}
    <div class="text-center dashboard-section1 d-flex flex-column justify-content-center align-items-center">
        <h3>لا يوجد فرص للتصويت حاليا</h3>
        <p class="text-muted">قم بانتظار المسؤول لاضافة الفرصة</p>
    </div>
    {% endif %}
  </div>
      
      <div class="modal fade" id="votingModal" tabindex="-1" aria-labelledby="votingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header d-flex justify-content-between p-0 px-3 py-2">
                <h5 class="modal-title" id="votingModalLabel">إضافة تصويت جديد</h5>
                <button type="button" class="btn-close m-0 p-0" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{% url 'investments:add_voting' %}" enctype="multipart/form-data">
                    {% csrf_token %}
      
                    <div class="mb-3">
                        <label for="opportunity" class="form-label" style="color: #761305;">اختَر الفرصة الاستثمارية</label>
                        <select class="form-select" id="opportunity" name="opportunity" required>
                            <option value="">-- اختر الفرصة --</option>
                            {% for opportunity in opportunities %}
                                <option value="{{ opportunity.id }}">{{ opportunity.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
        
                    <div class="mb-3">
                        <label for="vote_type" class="form-label" style="color: #761305;">نوع التصويت</label>
                        <label class="form-control" style="background-color: #f1f1f1;">شراء</label>
                        <input type="hidden" name="vote_type" value="buy">
                    </div>
        
                    <div class="mb-3">
                        <label for="required_approval_percentage" class="form-label" style="color: #761305;">النسبة المطلوبة للموافقة</label>
                        <input type="number" class="form-control" id="required_approval_percentage" name="required_approval_percentage" required min="0" max="100">
                    </div>
        
                    <div class="mb-3">
                        <label for="voting_start_time" class="form-label" style="color: #761305;">تاريخ بداية التصويت</label>
                        <input type="datetime-local" class="form-control" id="voting_start_time" name="voting_start_time" required>
                    </div>
        
                    <div class="mb-3">
                        <label for="voting_end_time" class="form-label" style="color: #761305;">تاريخ نهاية التصويت</label>
                        <input type="datetime-local" class="form-control" id="voting_end_time" name="voting_end_time" required>
                    </div>
        
                    <div class="mb-3">
                        <label for="total_amount" class="form-label" style="color: #761305;">المبلغ الإجمالي</label>
                        <input type="number" class="form-control" id="total_amount" name="total_amount">
                    </div>
        
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                        <button type="submit" class="btn btn-darkgreen">إضافة التصويت</button>
                    </div>
                </form>
            </div>
        </div>
      </div>
      </div>
          <div id="section3" class="dashboard-section" style="display: none;">
            <div class="container p-0">
                <!-- Section 3 Header -->
                <div class="text-center mb-4">
                    <h2 style="color: #761305;">تفاصيل الأرباح</h2>
                    <p>سحب الأرباح المحققة من استثماراتك</p>
                </div>
        
<!-- Profit Table -->
<div class="profit-container p-4 bg-white shadow-sm rounded">
    <table class="table table-striped text-center">
        <thead>
            <tr>
                <th>اسم الصندوق</th>
                <th>المبلغ المستثمر</th>
                <th>الأرباح المتوقعة</th>
                <th>الحالة</th>
            </tr>
        </thead>
        <tbody>
            {% for fund in profit_data %}
            <tr>
                <td>{{ fund.fund_name }}</td>
                <td>{{ fund.amount_invested }} ر.س</td>
                <td>{{ fund.profit }} ر.س</td>
                <td>{{ fund.status }}</td>  
                <!-- <td>
                    {% if fund.transfer_enabled %}
                    <button class="btn btn-action btn-darkred withdraw mb-2" data-bs-toggle="modal" data-bs-target="#withdrawModal">
                        سحب الأرباح
                    </button>
                    {% else %}
                    <button type="button" class="btn btn-disabled" disabled>غير متاح</button>
                    {% endif %}
                </td> -->
            </tr>
            {% endfor %}
        </tbody>                                                                                                    
    </table>
</div>
            </div>
        </div>        
        <div id="section4" class="dashboard-section" style="display: none;">
            <div class="container p-0">
                <!-- Section 4 Header -->
                <div class="wallet-header">
                    <h3>محفظتي الرقمية</h3>
                    <p>التحكم في أموالك بطريقة بسيطة وآمنة</p>
                </div>
                <!-- Wallet Container -->
<div class="wallet-container row mt-4 p-3 bg-white shadow-sm rounded">
    <div class="col-md-6">
        {% if wallet %}
        <div class="d-flex flex-column justify-content-between h-100">
            <p>الرصيد: <strong class="fs-1">{{ wallet.balance }} </strong>ريال</p>
            <small class="text-muted">آخر تحديث: {{ wallet.last_updated|date:"Y-m-d H:i:s" }}</small>
    
        </div>
    {% else %}
        <p>سيتم انشاء محفظتك خلال ثواني...</p>
    {% endif %}
    </div>
    <div class="col-md-6">
        <button class="btn btn-action btn-darkgreen add-funds mb-2" data-bs-toggle="modal" data-bs-target="#depositModal">
            إضافة أموال <i class="fa-solid fa-plus"></i>
        </button>
        <button class="btn btn-action btn-darkgreen transfer mb-2" data-bs-toggle="modal" data-bs-target="#transferModal">
            تحويل الأموال <i class="fa-solid fa-money-bill-transfer"></i>
        </button>
        <div class="text-center">
            <!-- Button to Trigger Modal -->
            <button class="btn btn-action btn-warning withdraw mb-2" data-bs-toggle="modal" data-bs-target="#withdrawModal">
                سحب الأرباح <i class="fa-solid fa-money-bill-trend-up"></i>
            </button>
        </div> 
    </div>
</div>
<div class="wallet-container row mt-2 p-3 bg-white shadow-sm rounded">
    <div class="col-md-4 d-flex flex-column align-items-start my-3 justify-content-between">
        <h5 class="text-center">العمليات الاخيرة</h5>
        <a href="{% url 'investment_fund:wallet_view' %}" class="btn btn-darkgreen"><i class="fa-regular fa-file-lines"></i> عرض سجل العمليات</a>                       
    </div>

    <div class="col-md-8">
        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead class="thead-dark">
                    <tr>
                        <th>التاريخ</th>
                        <th> العملية</th>
                        <th>المبلغ</th>
                        <th>الوصف</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in transactions %}
                    <tr>
                        <td>{{ transaction.created_at|date:"Y-m-d H:i:s" }}</td>
                        <td>{{ transaction.get_transaction_type_display }}</td>
                        <td>{{ transaction.amount }}</td>
                        <td>{{ transaction.description }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center">لا توجد عمليات حالياً.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>           
            </div>
<!-- Deposit Modal -->
<div class="modal fade" id="depositModal" tabindex="-1" aria-labelledby="depositModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header d-flex justify-content-between w-100">
              <h5 class="modal-title" id="depositModalLabel">إضافة أموال إلى المحفظة</h5>
              <button type="button" class="btn-close m-0" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <form method="POST" action="{% url 'investment_fund:deposit_to_wallet' %}">
                  {% csrf_token %}
                  <div class="mb-3">
                      <label for="amount" class="form-label">المبلغ</label>
                      <input type="number" name="amount" id="amount" class="form-control" placeholder="أدخل المبلغ" required>
                  </div>
                  <div class="mb-3">
                      <label for="description" class="form-label">الوصف</label>
                      <input type="text" name="description" id="description" class="form-control" placeholder="اختياري">
                  </div>
                  <button type="submit" class="btn btn-darkgreen w-100 mt-3">إتمام الإيداع</button>
              </form>
          </div>
      </div>
    </div>
  </div>
  

<!-- Transfer Modal -->
<div class="modal fade" id="transferModal" tabindex="-1" aria-labelledby="transferModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header d-flex justify-content-between w-100">
                <h5 class="modal-title" id="transferModalLabel">تحويل أموال إلى الصندوق</h5>
                <button type="button" class="btn-close m-0" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <!-- Check if joined funds are available -->
                {% if joined_funds %}
                    <form method="POST" action="{% url 'investment_fund:transfer_to_fund' pk=joined_funds.first.fund.id %}">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="amount" class="form-label">المبلغ</label>
                            <input type="number" name="amount" class="form-control" id="amount" placeholder="أدخل المبلغ" required>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">الوصف (اختياري)</label>
                            <input type="text" name="description" id="description" class="form-control" placeholder="أدخل وصف التحويل">
                        </div>

                        <div class="mb-3">
                            <label for="fund_id" class="form-label">اختر صندوق الاستثمار</label>
                            <select name="fund_id" id="fund_id" class="form-control" required>
                                <option value="" disabled selected>اختر صندوق الاستثمار</option>
                                {% for fund in joined_funds %}
                                    <option value="{{ fund.fund.id }}">{{ fund.fund.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <button type="submit" class="btn btn-darkred w-100">إتمام التحويل</button>
                    </form>
                {% else %}
                    <p class="text-center">لم تقم بالانضمام إلى أي صناديق استثمار بعد.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

                </div>
                  <div id="section5" class="dashboard-section" style="display: none;">
                    <div class="container-wrapper-profile">
                      <div id="alert-container"></div>
                      <div class="profile-container container">
                          <div class="profile-image-container row w-100">
                            <div class="col-md-8 d-flex gap-3 align-items-start ">
                              <h2 class="mb-3"> بيانات الحساب  </h2>
                              <div class="mt-2">
                                <span class="edit-icon" id="edit-image-icon"><i class="fas fa-pencil-alt"></i></span>
                                <span class="check-icon hidden" id="check-icon"><i class="fas fa-check"></i></span>    
                              </div>
                            </div>
                              <div class=" col-md-4">
                                <img src="{{ user.profile_picture.url }}" alt="Profile Image" class="profile-image rounded-3 " id="profile-img">
                              </div>
      
                          </div>
                          
                          <div class="profile-info mt-3">
                              <form id="profile-form" method="POST" enctype="multipart/form-data">
                                  {% csrf_token %}
                                  
                                  <div class="form-group">
                                      <label for="full_name">الاسم الكامل</label>
                                      <input type="text" class="form-control" value="{{ user.full_name }}" name="full_name" id="full-name" disabled>
                                  </div>
                  
                                  <div class="form-group">
                                      <label for="username">اسم المستخدم</label>
                                      <input type="text" class="form-control" value="{{ user.username }}" name="username" id="username" disabled>
                                  </div>
                  
                                  <div class="form-group">
                                      <label for="email">البريد الإلكتروني</label>
                                      <input type="email" class="form-control" value="{{ user.email }}" name="email" id="email" disabled>
                                  </div>
                  
                                  <div class="form-group">
                                      <label for="phone_number">رقم الجوال</label>
                                      <input type="text" class="form-control" value="{{ user.phone_number }}" name="phone_number" id="phone-number" disabled>
                                  </div>
                  
                                  <div class="form-group">
                                      <label for="dob">تاريخ الميلاد</label>
                                      <input type="date" class="form-control" value="{{ user.date_of_birth|date:'Y-m-d' }}" name="date_of_birth" id="dob" disabled>
                                  </div>
                  
                                  <div class="form-group hidden" id="profile-picture-group">
                                      <label for="profile_picture">الصورة الشخصية</label>
                                      <input type="file" class="form-control" name="profile_picture" id="profile-picture">
                                  </div>
                  
                                  <div class="form-group hidden" id="password-group">
                                      <label for="password">كلمة المرور الجديدة</label>
                                      <input type="password" class="form-control" placeholder="أدخل كلمة المرور الجديدة" name="password" id="password">
                                  </div>
                  
                                  <div class="form-group hidden" id="password-confirm-group">
                                      <label for="password_confirm">تأكيد كلمة المرور</label>
                                      <input type="password" class="form-control" placeholder="تأكيد كلمة المرور" name="password_confirm" id="password_confirm">
                                  </div>
                              </form>
                          </div>
                      </div>
                  </div>
               
                </div>

              </div>
              <!-- Withdraw Profit Modal -->
<div class="modal fade" id="withdrawModal" tabindex="-1" aria-labelledby="withdrawModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header d-flex justify-content-between w-100">
                <h5 class="modal-title" id="withdrawProfitModalLabel">سحب الأرباح</h5>
                <button type="button" class="btn-close m-0" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{% url 'investment_fund:withdraw_profit' %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="amount" class="form-label">المبلغ المراد سحبه</label>
                        <input type="number" name="profit" id="amount" class="form-control" placeholder="أدخل المبلغ" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">الوصف (اختياري)</label>
                        <input type="text" name="description" id="description" class="form-control" placeholder="أدخل وصف السحب">
                    </div>
                    <div class="mb-3">
                        <label for="fund" class="form-label">اختار صندوق الاستثمار</label>
                        <select name="fund_id" class="form-control" required>
                            {% for fund in joined_funds %}
                                <option value="{{ fund.fund.id }}">
                                    {{ fund.fund.name }} - ربح: {{ fund.profit }} ريال
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="action" class="form-label">العملية</label>
                        <select name="action" class="form-control">
                            <option value="withdraw_to_wallet">سحب إلى المحفظة</option>
                            <option value="reinvest_in_fund">إعادة استثمار في الصندوق</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-darkgreen w-100">تأكيد السحب</button>
                </form>                
            </div>
        </div>
    </div>
    
          <div id="section5" class="dashboard-section" style="display: none;">
                        <div class="container-wrapper-profile">
                          <div id="alert-container"></div>
                          <div class="profile-container container">
                              <div class="profile-image-container row w-100">
                                <div class="col-md-8 d-flex gap-3 align-items-start ">
                                  <h2 class="mb-3"> بيانات الحساب  </h2>
                                  <div class="mt-2">
                                    <span class="edit-icon" id="edit-image-icon"><i class="fas fa-pencil-alt"></i></span>
                                    <span class="check-icon hidden" id="check-icon"><i class="fas fa-check"></i></span>    
                                  </div>
                                </div>
                                  <div class=" col-md-4">
                                    <img src="{{ user.profile_picture.url }}" alt="Profile Image" class="profile-image rounded-3 " id="profile-img">
                                  </div>
    
                              </div>
                              
                              <div class="profile-info mt-3">
                                  <form id="profile-form" method="POST" enctype="multipart/form-data">
                                      {% csrf_token %}
                                      
                                      <div class="form-group">
                                          <label for="full_name">الاسم الكامل</label>
                                          <input type="text" class="form-control" value="{{ user.full_name }}" name="full_name" id="full-name" disabled>
                                      </div>
                      
                                      <div class="form-group">
                                          <label for="username">اسم المستخدم</label>
                                          <input type="text" class="form-control" value="{{ user.username }}" name="username" id="username" disabled>
                                      </div>
                      
                                      <div class="form-group">
                                          <label for="email">البريد الإلكتروني</label>
                                          <input type="email" class="form-control" value="{{ user.email }}" name="email" id="email" disabled>
                                      </div>
                      
                                      <div class="form-group">
                                          <label for="phone_number">رقم الجوال</label>
                                          <input type="text" class="form-control" value="{{ user.phone_number }}" name="phone_number" id="phone-number" disabled>
                                      </div>
                      
                                      <div class="form-group">
                                          <label for="dob">تاريخ الميلاد</label>
                                          <input type="date" class="form-control" value="{{ user.date_of_birth|date:'Y-m-d' }}" name="date_of_birth" id="dob" disabled>
                                      </div>
                      
                                      <div class="form-group hidden" id="profile-picture-group">
                                          <label for="profile_picture">الصورة الشخصية</label>
                                          <input type="file" class="form-control" name="profile_picture" id="profile-picture">
                                      </div>
                      
                                      <div class="form-group hidden" id="password-group">
                                          <label for="password">كلمة المرور الجديدة</label>
                                          <input type="password" class="form-control" placeholder="أدخل كلمة المرور الجديدة" name="password" id="password">
                                      </div>
                      
                                      <div class="form-group hidden" id="password-confirm-group">
                                          <label for="password_confirm">تأكيد كلمة المرور</label>
                                          <input type="password" class="form-control" placeholder="تأكيد كلمة المرور" name="password_confirm" id="password_confirm">
                                      </div>
                                  </form>
                              </div>
                          </div>
                      </div>
                  </div>   
      </div>
  

</section>
  {%endblock%}
  {%block script%}
  <script>
    const ctx = document.getElementById('fundsChart');
    const backgroundColors = [
        'rgba(153, 51, 66, 0.2)',  // Darker red
        'rgba(153, 79, 32, 0.2)',  // Darker orange
        'rgba(204, 153, 68, 0.2)', // Darker yellow
        'rgba(51, 153, 153, 0.2)', // Darker teal
        'rgba(43, 122, 176, 0.2)', // Darker blue
        'rgba(102, 51, 204, 0.2)', // Darker purple
        'rgba(153, 153, 153, 0.2)'  // Darker grey
    ];
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: {{CHlables_funds|safe}},
        datasets: [{
          label: '',
          data: {{CHdata_funds|safe}},
          backgroundColor: backgroundColors,
          borderColor: [
         'rgb(153, 49, 66)',   // Darker red
  'rgb(153, 79, 32)',   // Darker orange
  'rgb(204, 153, 68)',  // Darker yellow
  'rgb(51, 153, 153)',  // Darker teal
  'rgb(43, 122, 176)',  // Darker blue
  'rgb(102, 51, 204)',  // Darker purple
  'rgb(153, 153, 153)'  // Darker grey
          ],
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  </script>
  <!--
  <script>
    const ctx = document.getElementById('fundsChart');
  
    const labels =  {{ CHlables_funds|safe }};
    const dataValues = {{ CHdata_funds|safe }};
  
    const backgroundColors = [
      'rgba(15, 46, 41, 0.6)',
      'rgba(118, 19, 5, 0.6)',
      'rgba(0, 0, 0, 0.6)'
    ];
  
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'الصندوق',
          data: dataValues,
          backgroundColor: backgroundColors,
          borderColor: [
            'rgba(15, 46, 41, 1)',
            'rgba(118, 19, 5, 1)',
            'rgba(0, 0, 0, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  </script>-->
  


  <script>
    $(document).ready(function () {
        $('#edit-image-icon').click(function () {
            $('input').prop('disabled', false);
            $('#profile-picture-group, #password-group, #password-confirm-group').removeClass('hidden');
            $('#save-btn-container').removeClass('hidden'); 
            $('#check-icon').removeClass('hidden'); 
            $('#edit-image-icon').hide(); 
        });
        $('#check-icon').click(function () {
            $('#profile-form').submit(); 
        });
        $('#profile-form').submit(function (e) {
            e.preventDefault();
            var formData = new FormData(this); 
            $.ajax({
                url: '{% url "accounts:update_profile" %}',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function(response) {
                    $('#full-name').val(response.full_name);
                    $('#username').val(response.username);
                    $('#email').val(response.email);
                    $('#phone-number').val(response.phone_number);
                    $('#dob').val(response.date_of_birth);
                    $('#profile-img').attr('src', response.profile_picture_url);
                    $('input').prop('disabled', true);
                    $('#profile-picture-group, #password-group, #password-confirm-group').addClass('hidden');
                    $('#save-btn-container').addClass('hidden');
                    $('#edit-image-icon').show();
                    $('#check-icon').addClass('hidden'); 
                    $('#alert-container').html('<div class="alert alert-success">تم تحديث البيانات بنجاح!</div>');
                    setTimeout(function() {
                        $('.alert').fadeOut();
                    }, 3000);
                },
                error: function(xhr, status, error) {
                    $('#alert-container').html('<div class="alert alert-danger">حدث خطأ أثناء التحديث.</div>');
                    setTimeout(function() {
                        $('.alert').fadeOut();
                    }, 3000);
                }
            });
        });
    });
  </script>

  <script>
    // Show relevant payment details based on selected method
    document.getElementById('payment-method').addEventListener('change', function() {
      const method = this.value;
      const paymentDetails = document.querySelectorAll('.payment-details');
      paymentDetails.forEach(detail => {
        detail.style.display = 'none';
      });
  
      if (method === 'bank') {
        document.getElementById('bank-details').style.display = 'block';
      } else if (method === 'credit-card') {
        document.getElementById('credit-card-details').style.display = 'block';
      } else if (method === 'e-wallet') {
        document.getElementById('e-wallet-details').style.display = 'block';
      }
    });
  </script>
 <script>
    // Handle the section content change
    const navLinks = document.querySelectorAll('.nav-link-dashboard');
    const sections = document.querySelectorAll('.dashboard-section');

    window.onload = function() {
    const urlParams = new URLSearchParams(window.location.search);
    const activeSection = urlParams.get('section');  // الحصول على القسم من معلمة الـ URL

    if (activeSection) {
        document.getElementById(activeSection).classList.add('active');
        document.getElementById(activeSection).style.display = 'block'; // إظهار القسم الافتراضي
        document.querySelector(`.nav-link-dashboard[data-content="${activeSection}"]`).classList.add('active');
        const defaultSection = 'section1'; 
        document.getElementById(defaultSection).style.display = 'none'; 
        document.querySelector(`.nav-link-dashboard[data-content="${defaultSection}"]`).classList.remove('active');

    } else {  
        const defaultSection = 'section1'; 
        document.getElementById(defaultSection).style.display = 'block'; 
        document.querySelector(`.nav-link-dashboard[data-content="${defaultSection}"]`).classList.add('active');
    }
}

    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();

            // Remove the 'active' class from all nav links
            navLinks.forEach(link => link.classList.remove('active'));
            // Add 'active' class to the clicked link
            link.classList.add('active');

            // Hide all sections
            sections.forEach(section => {
                section.style.display = 'none';
            });

            // Show the content corresponding to the clicked section
            const sectionId = link.getAttribute('data-content');
            const activeSection = document.getElementById(sectionId);
            activeSection.style.display = 'block';
        });
    });

</script>

{%endblock%}