{% extends 'main/base.html'%}
{%load static%}
{% block head %}
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="{% static 'css/main.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .modal-content {
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .modal-dialog {
        max-width: 900px;
    }

    .modal-header {
        background-color: #761305;
        color: white;
        font-weight: bold;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        padding-left: 60px;
    }


    .modal-footer {
        border-bottom-left-radius: 10px;
        border-bottom-right-radius: 10px;
    }

    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid #ddd;
        transition: border-color 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: #761305;
        box-shadow: 0 0 5px rgba(118, 19, 5, 0.5);
    }


    .modal-footer .btn-secondary {
        background-color: #ccc;
        border-color: #ccc;
        border-radius: 8px;
    }

    .modal-footer .btn-secondary:hover {
        background-color: #aaa;
        border-color: #aaa;
    }

    .modal-body {
        padding: 30px;
    }
</style>
{% endblock %}

{%block title%}<title>لوحة التحكم - الصندوق</title>{%endblock%}
{%block content%}
<section class="container rounded-3 shadow dashboard">
  <div class="row dashboard-row">
      <!-- Sidebar -->
      <div class="col-md-3 p-3 d-flex flex-column justify-content-between dashboard-side">
        <div>
          <h4 class=" mb-4 text-center ">مرحبا <span>{{leader.user.full_name}}</span></h4>
          <ul class="nav flex-column dashboard-links">
              <li class="nav-item">
                  <a class="nav-link-dashboard active" href="#" data-content="section1">
                    <i class="fa-solid fa-landmark"></i>
                    <span class="px-2">الصندوق</span> 
                  </a>
              </li>
              <li class="nav-item">
                  <a class="nav-link-dashboard" href="#" data-content="section2">
                    <i class="fa-solid fa-bullhorn"></i>
                    <span class="px-2">التصويت</span> 
                  </a>
              </li>
              <li class="nav-item">
                  <a class="nav-link-dashboard" href="#" data-content="section3">
                    <i class="fa-solid fa-coins"></i>
                    <span class="px-2">الأرباح</span> 
                  </a>
              </li>
              <li class="nav-item">
                  <a class="nav-link-dashboard" href="#" data-content="section4">
                    <i class="fa-solid fa-money-bill-transfer"></i>
                    <span class="px-2">الفرص الاستثمارية</span> 
  
                  </a>
              </li>
              <li class="nav-item">
                  <a class="nav-link-dashboard" href="#" data-content="section5">
                    <i class="fa-solid fa-users"></i>
                    <span class="px-2">الأفراد </span> 

                  </a>
              </li>
              <li class="nav-item">
                  <a class="nav-link-dashboard" href="#" data-content="section6">
                    <i class="fa-solid fa-wallet"></i>
                    <span class="px-2">المحفظة</span> 

                  </a>
              </li>
          </ul>
        </div>
        <div class="d-flex justify-content-center">
    {% if investment_fund %}
      {% if unique_code %}
      <button class="btn btn-darkgreen" data-bs-toggle="modal" data-bs-target="#codeModal">
        استعراض الرمز
        <!--<button id="shareButton">Share Code</button>-->
      </button>
      {%else%}
      <div class="d-flex flex-column align-items-center justify-content-center">
       <p class="text-center">   لم يتم إنشاء رمز الانضمام حتى الآن.</p>
      <form method="POST">
        {% csrf_token %}
        <button type="submit" name="new_code" class="btn btn-darkgreen">إنشاء الرمز <i class="fa-solid fa-plus"></i></button>
    </form>
  </div>
      {% endif %}
      {% endif %}
          <!-- Modal Structure -->
          <div class="modal fade" id="codeModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content w-100">
                <div class="modal-header  d-flex justify-content-between p-0 py-1 px-2 w-100">
                  <h5 class="modal-title" id="exampleModalLabel">الرمز</h5>
                  <button type="button" class="btn-close m-0" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body ">
                  {% if unique_code %}
                <h2 class="text-center">{{ unique_code }}</h2>
                  {% endif %}
                </div>
                <div class="modal-footer border-white ">
                  <button type="button" class="btn btn-light w-100 " data-bs-dismiss="modal">تم</button>
                </div>
              </div>
            </div>
          </div>
          
        </div>
      </div>

      <!-- Content Area -->
      <div class="col-md-9 p-3">
        {% if messages %}
        {% for message in messages %}
        {% if not request.session.show_message or message.tags != request.session.show_message %}
        <div class=" w-100">
            <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-success{% endif %} w-100 d-flex justify-content-between align-items-center" role="alert">
                {{ message }}
            <button type="button" class="btn-close m-0 px-2" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
            </div>
            {% endif %}
        {% endfor %}
      {% endif %}
        <div id="section1" class="dashboard-section">
          
            {% if investment_fund %}
                <!-- Display Investment Fund Details -->
                <div class="h-100 container dashboard-section1 d-flex flex-column justify-content-between" >      
                    <!-- Display Fund Data -->
                    <div class="row">
                        <div class="col-md-6">
                          <div class="d-flex justify-content-start align-items-center gap-3">
                            <p><span>صندوق : </span> <span class="fs-4">{{ investment_fund.name }}</span></p>

                            {% if investment_fund.is_active == 'Active' %}
                                 <span class="rounded-pill h-50 text-center mb-2 align-items-center d-flex justify-content-center border border-success px-4 fs-6 " style="background-color: rgb(201, 239, 201);">نشط</span> 
                              {% elif investment_fund.is_active == 'Inactive' %}
                              <span class="rounded-pill h-50 text-center mb-2 align-items-center d-flex justify-content-center border border-danger px-4 fs-6 " style="background-color: rgb(239, 201, 201);">غير نشط</span> 
                              {% else %}
                              <span class="rounded-pill h-50 text-center mb-2 align-items-center d-flex justify-content-center border border-success px-4 fs-6 " style="background-color: rgb(201, 239, 201);">نشط</span> 
                              {% endif %}
                          </div>
                            <p class="text-muted"><span class="text-dark">الوصف : </span> {{ investment_fund.description }}</p>                                                   
                          </p>                            
                          <p>رمز الانضمام :
                            {%if unique_code != None %} 
                            <strong id="unique_code">{{ unique_code }}</strong>
                            <button class="mx-1 copy-btn" onclick="copyFunction()"><i class="fa-regular fa-clone "></i></button>
                            {%else%}
                            <strong>
                             لا يوجد رمز {%endif%}
                          </strong> </p>
                        </div>
                        <div class="col-md-6 d-flex flex-column justify-content-center align-items-center">
                          
                            {% if investment_fund and investment_fund.total_balance %}
                            <p>الرصيد :</p>
                            <div>
                              <span class="text-center fs-1 fw-bold">{{ investment_fund.total_balance }} <span class="fs-6 fw-normal">ر.س</span>
                            </div>
                        {% else %}
                            <p>الرصيد : <strong>غير متاح</strong> </p>
                        {% endif %}
                        </div>
                    </div>
                    <!--Chart fund total , amount of investment , profits-->
                    <div class="container my-4" >
                      <div class="row">
                        <div class="col-md-6"><canvas id="fundChart" width="100" height="200"></canvas>
                        </div>
                        <div class="col-md-6">
                          <div class=" my-2 d-flex gap-2 align-items-end justify-content-center h-100">
                            <a href="{% url 'investment_fund:update_investment_fund' investment_fund.pk %}" class="btn btn-darkgreen">
                              <i class="bi bi-pencil-fill"></i>  تعديل الصندوق
                            </a>
                            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteFundModal">
                              <i class="bi bi-trash-fill"></i> حذف الصندوق
                            </button>                        
                        </div>
                        </div>

                      </div>
                      <!-- Your chart will be rendered here -->
                  </div>
                    <!-- Action Buttons -->
                  
                </div>
            {% else %}
                <!-- If No Fund Exists -->
                <div class="text-center dashboard-section1 d-flex flex-column justify-content-center align-items-center">
                    <h3>لا يوجد صندوق حاليا</h3>
                    <p class="text-muted">قم بإنشاء الصندوق الآن</p>
                    <!-- Create Fund Button -->
                    <button type="button" class="btn btn-darkgreen" data-bs-toggle="modal" data-bs-target="#createFundModal">
                        إنشاء الصندوق <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
            {% endif %}
        </div>        
          <!-- Modal -->
    <div class="modal fade" id="createFundModal" tabindex="-1" aria-labelledby="createFundModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              <div class="modal-header d-flex justify-content-between p-0 px-3 py-2" >
                  <h5 class="modal-title" id="createFundModalLabel">إنشاء صندوق جديد</h5>
                  <button type="button" class="btn-close m-0" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="container mt-5 d-flex justify-content-center">
                    <form method="POST" action="{% url 'investment_fund:create_investment_fund' %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="name" class="form-label" style="color: #761305;">اسم الصندوق</label>
                            <input type="text" class="form-control" id="name" name="name" placeholder="أدخل اسم الصندوق" required>
                        </div>
                    
                        <div class="mb-3">
                            <label for="description" class="form-label" style="color: #761305;">وصف الصندوق</label>
                            <textarea class="form-control" id="description" name="description" rows="3" placeholder="أدخل وصف الصندوق" required></textarea>
                        </div>
                    
                        <!-- <div class="mb-3">
                            <label for="total_balance" class="form-label" style="color: #761305;">الرصيد الكلي</label>
                            <input type="number" class="form-control" id="total_balance" name="total_balance" placeholder="0.0" required>
                        </div> -->
                    
                        <div class="mb-3">
                            <label for="is_active" class="form-label" style="color: #761305;">الحالة</label>
                            <select class="form-select" id="is_active" name="is_active" required>
                                <option value="Active">نشط</option>
                                <option value="Inactive">غير نشط</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                            <button type="submit" class="btn btn-darkgreen">إنشاء الصندوق</button>
                        </div>
                    </form>
            </div>
        </div>
    </div>
</div>
</div>
<!-- Delete Confirmation Modal -->
{% if investment_fund %}
    <div class="modal fade" id="deleteFundModal" tabindex="-1" aria-labelledby="deleteFundModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header d-flex justify-content-between p-0 px-3 py-2">
                    <h5 class="modal-title" id="deleteFundModalLabel">تأكيد الحذف</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                </div>
                <div class="modal-body">
                    هل أنت متأكد أنك تريد حذف هذا الصندوق الاستثماري؟ لا يمكن التراجع عن هذا الإجراء.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <form method="POST" action="{% url 'investment_fund:delete_investment_fund' investment_fund.pk %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">نعم، حذف</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% else %}
{% endif %}


<!-- التصويت-->
<div id="section2" class="dashboard-section container" style="display: none;">
  {% if investments %}
  <div class="d-flex align-items-end justify-content-end">
      <button class="btn btn-darkgreen" data-bs-toggle="modal" data-bs-target="#votingModal">
          إضافة تصويت جديد <i class="fa-solid fa-plus"></i>
      </button>
  </div>
  

<div class="modal fade" id="votingModal" tabindex="-1" aria-labelledby="votingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header d-flex justify-content-between p-0 px-3 py-2">
          <h5 class="modal-title" id="votingModalLabel">إضافة تصويت جديد</h5>
          <button type="button" class="btn-close m-0 p-0" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
          <form method="POST" action="{% url 'investments:add_voting' %}" enctype="multipart/form-data">
              {% csrf_token %}

              <div class="mb-3">
                  <label for="opportunity" class="form-label" style="color: #761305;">اختَر الفرصة الاستثمارية</label>
                  <select class="form-select" id="opportunity" name="opportunity" required>
                      <option value="">-- اختر الفرصة --</option>
                      {% for opportunity in opportunities %}
                          <option value="{{ opportunity.id }}">{{ opportunity.title }}</option>
                      {% endfor %}
                  </select>
              </div>
  
              <div class="mb-3">
                  <label for="vote_type" class="form-label" style="color: #761305;">نوع التصويت</label>
                  <label class="form-control" style="background-color: #f1f1f1;">شراء</label>
                  <input type="hidden" name="vote_type" value="buy">
              </div>
  
              <div class="mb-3">
                  <label for="required_approval_percentage" class="form-label" style="color: #761305;">النسبة المطلوبة للموافقة</label>
                  <input type="number" class="form-control" id="required_approval_percentage" name="required_approval_percentage" required min="0" max="100">
              </div>
  
              <div class="mb-3">
                  <label for="voting_start_time" class="form-label" style="color: #761305;">تاريخ بداية التصويت</label>
                  <input type="datetime-local" class="form-control" id="voting_start_time" name="voting_start_time" required>
              </div>
  
              <div class="mb-3">
                  <label for="voting_end_time" class="form-label" style="color: #761305;">تاريخ نهاية التصويت</label>
                  <input type="datetime-local" class="form-control" id="voting_end_time" name="voting_end_time" required>
              </div>
  
  
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                  <button type="submit" class="btn btn-darkgreen">إضافة التصويت</button>
              </div>
          </form>
      </div>
  </div>
</div>
</div>
<div class="row my-2 ">
  {% for opportunity in opportunities %}
  <div class="card mb-3">
      <div class="card-body container">
        <div class="row">
          <div class="col-md-6">
            <h5 class="card-title" style="color: #761305;">{{ opportunity.title }}</h5>
            <p class="card-text"><strong>المبلغ الإجمالي:</strong> {{ opportunity.total_investment }} ريال</p>
            <p class="card-text"><strong>العائد المتوقع:</strong> {{ opportunity.expected_return }}%</p>
            <p class="card-text"><strong>تاريخ البداية:</strong> {{ opportunity.start_date|date:"Y-m-d" }}</p>
            <p class="card-text"><strong>تاريخ الانتهاء:</strong> {{ opportunity.end_date|date:"Y-m-d" }}</p>
  
          </div>
          <div class="col-md-6">
            <p class="card-text"><strong>النسبة المطلوبة للموافقة:</strong> {{ opportunity.required_approval_percentage }}%</p>
            <p class="card-text"><strong>نسبة الموافقه:</strong> {{ opportunity.approval_percentage }}%</p>
            <p class="card-text"><strong>قبول :</strong> {{ opportunity.accepted_votes }}</p>
            <p class="card-text"><strong>رفض :</strong> {{ opportunity.rejected_votes }}</p>
  
          </div>
        </div>

          <p class="card-text">
              {% if opportunity.status == 'Closed' %}
                  <span class="badge bg-dark">تم إغلاق التصويت</span>
              {% elif opportunity.status == 'Open' %}
                  {% if opportunity.pending_votes > 0 %}
                      <span class="badge bg-warning">التصويت قيد الانتظار</span>
                  {% else %}
                      <span class="badge bg-success">التصويت مكتمل</span>
                  {% endif %}
              {% elif opportunity.status == 'Not Started' %}
                  <span class="badge bg-secondary">لم يتم بدء التصويت</span> 
              {% endif %}
          </p>

          <div class="d-flex justify-content-between ">
            <div class="d-flex flex-column align-items-end justify-content-end "> 
              <a href="{% url 'investments:investment_opportunity_detail' id=opportunity.id %}" class="btn btn-darkgreen">تفاصيل الفرصة</a>
            </div>

              {% if opportunity.status == 'Open' and user_investor %}
                  <form method="POST" action="{% url 'investments:vote_on_opportunity' id=opportunity.id %}">
                      {% csrf_token %}
                      <button type="submit" name="vote_choice" value="Accepted" class="btn btn-success">أوافق</button>
                      <button type="submit" name="vote_choice" value="Rejected" class="btn btn-danger">أرفض</button>
                  </form>
              {% elif opportunity.status == 'Closed' %}
              {% if opportunity.status == 'Closed' and request.user == opportunity.fund.leader.user %}
              <form method="POST" class=" row-gap-1">
                  {% csrf_token %}
                  
                  <label for="new_start_time" class="form-label" style="color: #761305;">تاريخ بداية التصويت الجديد</label>
                  <input type="datetime-local" class="form-control" id="new_start_time" name="new_start_time" value="{{ opportunity.start_date|date:'Y-m-d\TH:i' }}" required>
          
                  <label for="new_end_time" class="form-label" style="color: #761305;">تاريخ نهاية التصويت الجديد</label>
                  <input type="datetime-local" class="form-control" id="new_end_time" name="new_end_time" value="{{ opportunity.end_date|date:'Y-m-d\TH:i' }}" required>
          
                  <button type="submit" name="reopen_vote" class="btn btn-warning mt-2">إعادة فتح التصويت</button>
              </form>
          {% endif %}
        
              {% endif %}

          </div>
      </div>
  </div>
  {% endfor %}
</div>
<br/>
<navbar aria-label="Page navigation example">
    <ul class="pagination justify-content-center gap-4">
        {% if opportunities.has_next %}
            <li class="page-item">
                <a class="page-link rounded-3 px-3 py-2" href="?page={{ opportunities.next_page_number }}&section=section2" aria-label="Next">
                    <span aria-hidden="true"><i class="fa-solid fa-chevron-right"></i></span>
                </a>
            </li>
        {% else %}
            <li class="page-item disabled">
                <span class="page-link rounded-3 px-3 py-2" aria-hidden="true"><i class="fa-solid fa-chevron-right"></i></span>
            </li>
        {% endif %}

        {% if opportunities.has_previous %}
        <li class="page-item">
            <a class="page-link rounded-3 px-3 py-2" href="?page={{ opportunities.previous_page_number }}&section=section2" aria-label="Previous">
                <span aria-hidden="true"><i class="fa-solid fa-chevron-left"></i></span>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link rounded-3 px-3 py-2" aria-hidden="true"><i class="fa-solid fa-chevron-left"></i></span>
        </li>
        {% endif %}
    </ul>
</navbar>
  {% else %}
  <div class="text-center dashboard-section1 d-flex flex-column justify-content-center align-items-center">
      <h3>لا يوجد فرص حاليا</h3>
      <p class="text-muted">قم بإنشاء الفرص الآن</p>
      <button class="btn btn-darkgreen" data-bs-toggle="modal" data-bs-target="#votingModal">
          إضافة تصويت جديد <i class="fa-solid fa-plus"></i>
      </button>
  </div>
  {% endif %}
</div>


          <div id="section3" class="dashboard-section" style="display: none;">
            <div class="container mt-5">
              <div class="investment-summary p-4 bg-white shadow rounded">
                  <h3>اجمالي قيمة الاستثمار: {{ investment_fund.total_balance }} SAR</h3>
                  <h3>اجمالي الأرباح: {{ total_profit|floatformat:2 }} SAR</h3>
                  <hr>
                  <!-- <h4>حصص المستثمرين:</h4>
                  <table class="table table-bordered table-striped">
                      <thead class="thead-dark">
                          <tr>
                              <th>اسم الشخص</th>
                              <th>حصته</th>
                          </tr>
                      </thead>
                      <tbody>
                          {% for investor in investors %}
                              <tr>
                                  <td>{{ investor.investor.user.username }}</td>
                                  <td>{{ investor.amount_invested }} SAR</td>
                              </tr>
                          {% endfor %}
                      </tbody>
                  </table> -->

              </div>
          </div>          
          </div>
          <!--الفرص-->
          <div id="section4" class="dashboard-section container" style="display: none;">
            {%if investments%}
              
            <div class="d-flex align-items-end justify-content-end">
              <button class="btn btn-darkgreen" data-bs-toggle="modal" data-bs-target="#investmentOpportunityModal">
                فرصة جديدة <i class="fa-solid fa-plus"></i>
              </button>
            </div>
          <!--اضافة فرصة-->
          <div class="modal fade" id="investmentOpportunityModal" tabindex="-1" aria-labelledby="investmentOpportunityModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                      <div class="modal-header d-flex justify-content-between p-0 px-3 py-2">
                          <h5 class="modal-title" id="investmentOpportunityModalLabel">إضافة فرصة استثمارية جديدة</h5>
                          <button type="button" class="btn-close m-0 p-0" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                          <form method="POST" action="{%url 'investments:add_investment_opportunity'%}" enctype="multipart/form-data">
                              {% csrf_token %}
                          
                              <div class="mb-3">
                                  <label for="title" class="form-label" style="color: #761305;">عنوان الاستثمار</label>
                                  <input type="text" class="form-control" id="title" name="title" required>
                              </div>
  
                              <div class="mb-3">
                                  <label for="description" class="form-label" style="color: #761305;">وصف الاستثمار</label>
                                  <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                              </div>
  
                              <div class="mb-3">
                                  <label for="company_name" class="form-label" style="color: #761305;">اسم الشركة</label>
                                  <input type="text" class="form-control" id="company_name" name="company_name" required>
                              </div>
  
                              <div class="mb-3">
                                  <label for="investment_type" class="form-label" style="color: #761305;">نوع الاستثمار</label>
                                  <select class="form-select" id="investment_type" name="investment_type" required>
                                      <option value="Stocks">أسهم</option>
                                      <option value="Real Estate">عقارات</option>
                                  </select>
                              </div>
  
                              <div class="mb-3">
                                  <label for="total_investment" class="form-label" style="color: #761305;">المبلغ الإجمالي للاستثمار</label>
                                  <input type="number" class="form-control" id="total_investment" name="total_investment" required>
                              </div>                          
  
                              <div class="mb-3">
                                  <label for="start_date" class="form-label" style="color: #761305;">تاريخ البداية</label>
                                  <input type="date" class="form-control date-input" id="start_date" name="start_date" required>
                              </div>
  
                              <div class="mb-3">
                                  <label for="end_date" class="form-label" style="color: #761305;">تاريخ الانتهاء</label>
                                  <input type="date" class="form-control date-input" id="end_date" name="end_date" required>
                              </div>
  
                              <div class="mb-3">
                                  <label for="expected_return" class="form-label" style="color: #761305;"> الربح المتوقع %</label>
                                  <input type="number" class="form-control" id="expected_return" name="expected_return" max="100" min="0" required>
                              </div>
                              <div class="mb-3">
                                  <label for="image" class="form-label" style="color: #761305;">صورة الاستثمار</label>
                                  <input type="file" class="form-control" id="image" name="image" accept="image/*">
                              </div>
  
                              <div class="mb-3">
                                  <label for="pdf_file" class="form-label" style="color: #761305;">تحميل ملف PDF</label>
                                  <input type="file" class="form-control" id="pdf_file" name="pdf_file" accept="application/pdf">
                              </div>
  
                              <div class="modal-footer">
                                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                                  <button type="submit" class="btn btn-darkgreen">إضافة الفرصة</button>
                              </div>
                          </form>
                      </div>
                  </div>
              </div>
          </div>

            <div class="row gap-3 mt-3 w-100 d-flex align-items-center justify-content-center">
              {% for investment in investments%}
              <a href="{% url 'investments:investment_opportunity_detail' investment.id %}" class="col-md-4 investment-card p-0 rounded-3">
              <div>
                {% if investment.image%}
                 <img src="{{investment.image.url}}" class="w-100"/>
                 {%else%}
                 <img src="{%static 'images/building-66375_1280.jpg'%}" class="w-100"/>
                 {%endif%}
                <div class="p-2">
                  <div class="investment-description">
                    <h5>{{investment.title}}</h5>
                    <small class="text-muted">{{investment.description|truncatechars:40}}</small>  
                  </div>
                  <div class="d-flex justify-content-center align-items-center gap-3">
                    <div class="d-flex flex-column my-2 row-gap-1 justify-content-center align-items-center ">
                      <strong>{{investment.total_investment}} ر.س</strong>
                      <small class="text-muted">المبلغ</small>
                    </div>
                    <div class="d-flex flex-column row-gap-1 justify-content-center align-items-center ">
                      <strong>{{investment.expected_return}} %</strong>
                      <small class="text-muted">الربح المتوقع</small>
                    </div>
                  </div>
                  <div class="d-flex justify-content-between">
                    {% if investment.status == 'Open'%}
                    <div class="p-0 px-3 border border-success text-success rounded-pill  ">مفتوحة</div>
                    {%elif investment.status == 'Closed'%}
                    <div class="p-0 px-3 border border-danger text-danger rounded-pill  ">مغلقة</div>
                    {%else%}
                    <div class="p-0 px-3 border border-warning text-warning rounded-pill  ">مكتملة </div>
                    {%endif%}
                  </div>
                  </div>
              </div>
            </a>
              {%endfor%}
              <!--pagination-->
              <br/>
              <navbar aria-label="Page navigation example">
                  <ul class="pagination justify-content-center gap-4">
                      {% if investments.has_next %}
                          <li class="page-item">
                              <a class="page-link rounded-3 px-3 py-2" href="?page={{ investments.next_page_number }}&section=section4" aria-label="Next">
                                <span aria-hidden="true"><i class="fa-solid fa-chevron-right "></i></span>
                              </a>
                          </li>
                      {% else %}
                          <li class="page-item disabled">
                            <span class="page-link rounded-3 px-3 py-2" aria-hidden="true"><i class="fa-solid fa-chevron-right"></i></span>
                          </li>
                      {% endif %}

                      {% if investments.has_previous %}
                      <li class="page-item">
                          <a class="page-link rounded-3 px-3 py-2" href="?page={{ investments.previous_page_number }}&section=section4" aria-label="Previous">
                            <span aria-hidden="true"><i class="fa-solid fa-chevron-left"></i></span>
                          </a>
                      </li>
                  {% else %}

                      <li class="page-item disabled ">
                        <span class="page-link rounded-3 px-3 py-2" aria-hidden="true"><i class="fa-solid fa-chevron-left"></i></span>

                      </li>
                  {% endif %}
                  </ul>
              </navbar>    
            </div>
      {%else%}
            <div class="text-center dashboard-section1 d-flex flex-column justify-content-center align-items-center">
              <h3>لا يوجد فرص حاليا</h3>
              <p class="text-muted">قم بإنشاء الفرص الآن</p>
              <button class="btn btn-darkgreen" data-bs-toggle="modal" data-bs-target="#investmentOpportunityModal">
                فرصة جديدة <i class="fa-solid fa-plus"></i>
              </button>
          </div>
            <!--اضافة فرصة-->
            <div class="modal fade" id="investmentOpportunityModal" tabindex="-1" aria-labelledby="investmentOpportunityModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                      <div class="modal-header d-flex justify-content-between p-0 px-3 py-2">
                          <h5 class="modal-title" id="investmentOpportunityModalLabel">إضافة فرصة استثمارية جديدة</h5>
                          <button type="button" class="btn-close m-0 p-0" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                          <form method="POST" action="{%url 'investments:add_investment_opportunity'%}" enctype="multipart/form-data">
                              {% csrf_token %}
                          
                              <div class="mb-3">
                                  <label for="title" class="form-label" style="color: #761305;">عنوان الاستثمار</label>
                                  <input type="text" class="form-control" id="title" name="title" required>
                              </div>
  
                              <div class="mb-3">
                                  <label for="description" class="form-label" style="color: #761305;">وصف الاستثمار</label>
                                  <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                              </div>
  
                              <div class="mb-3">
                                  <label for="company_name" class="form-label" style="color: #761305;">اسم الشركة</label>
                                  <input type="text" class="form-control" id="company_name" name="company_name" required>
                              </div>
  
                              <div class="mb-3">
                                  <label for="investment_type" class="form-label" style="color: #761305;">نوع الاستثمار</label>
                                  <select class="form-select" id="investment_type" name="investment_type" required>
                                      <option value="Stocks">أسهم</option>
                                      <option value="Real Estate">عقارات</option>
                                  </select>
                              </div>
  
                              <div class="mb-3">
                                  <label for="total_investment" class="form-label" style="color: #761305;">المبلغ الإجمالي للاستثمار</label>
                                  <input type="number" class="form-control" id="total_investment" name="total_investment" required>
                              </div>                          
  
                              <div class="mb-3">
                                  <label for="start_date" class="form-label " style="color: #761305;">تاريخ البداية</label>
                                  <input type="date" class="form-control date-input" id="start_date" name="start_date" required>
                              </div>
  
                              <div class="mb-3">
                                  <label for="end_date" class="form-label " style="color: #761305;">تاريخ الانتهاء</label>
                                  <input type="date" class="form-control date-input" id="end_date" name="end_date" required>
                              </div>
  
                              <div class="mb-3">
                                  <label for="expected_return" class="form-label" style="color: #761305;"> الربح المتوقع %</label>
                                  <input type="number" class="form-control" id="expected_return" name="expected_return" max="100" min="0" required>
                              </div>
                              <div class="mb-3">
                                  <label for="investment_image" class="form-label" style="color: #761305;">صورة الاستثمار</label>
                                  <input type="file" class="form-control" id="investment_image" name="investment_image" accept="image/*">
                              </div>
  
                              <div class="mb-3">
                                  <label for="investment_pdf" class="form-label" style="color: #761305;">تحميل ملف PDF</label>
                                  <input type="file" class="form-control" id="investment_pdf" name="investment_pdf" accept="application/pdf">
                              </div>
  
                              <div class="modal-footer">
                                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                                  <button type="submit" class="btn btn-darkgreen">إضافة الفرصة</button>
                              </div>
                          </form>
                      </div>
                  </div>
              </div>
          </div>
      {%endif%}

          </div>
          <!--الحساب-->
          <div id="section5" class="container dashboard-section" style="display: none;">
            {%if fund_investors%}
            <div class="d-flex flex-column justify-content-between h-100">
              <div>
                <div class="row gap-2 justify-content-center">
                  {% for investor_fund in fund_investors%}
                  <div  class="col-md-5 person-card d-flex border p-0 rounded-3" >
                    <img src="{{investor_fund.investor.user.profile_picture.url}}" style="height: 30px; width:80px; object-fit: cover;"  class="h-100"/>
                    <div class="p-2 w-100 ">
                        <div class="d-flex flex-column">
                          <h6>{{investor_fund.investor.user.full_name}}</h6>
                          <h6>العمر: {{investor_fund.investor.age}} <small class="text-muted fw-light">عام</small> </h6>
                          <div class="d-flex justify-content-between align-items-center w-100">
                          <div class="d-flex gap-3 justify-content-start align-items-center">
                            <a href="tel:{{investor_fund.investor.user.phone_number}}"><i class="fa-solid fa-square-phone fs-4 investor-communication1"></i></a>
                            <a href="mailto:{{investor_fund.investor.user.email}}"><i class="fa-solid fa-square-envelope fs-4 investor-communication2"></i></a>
                          </div>
                           <div>
                            <button type="button" class="btn btn-darkred delete-member-btn" data-bs-toggle="modal" data-bs-target="#deleteInvestorModal">
                              <i class="fa-solid fa-user-xmark"></i>
                            </button>                            
                          </div>
                        </div>
                        </div>
                     
                      </div>
                  </div>

                   <!-- delete modal for investors-->
              <div class="modal fade" id="deleteInvestorModal" tabindex="-1" aria-labelledby="deleteInvestorModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header d-flex justify-content-between p-0 px-3 py-2">
                            <h5 class="modal-title" id="deleteInvestorModalLabel">تأكيد الحذف</h5>
                            <button type="button" class="btn-close m-0" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                        </div>
                        <div class="modal-body">
                            هل أنت متأكد أنك تريد حذف هذا العضو المستثمر؟ .
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                            <form method="POST" action="{% url 'investment_fund:delete_investor' investor_fund.investor.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger">نعم، حذف</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
                  {%endfor%}
                </div>

              </div>
              <div>
                <br/>
                <navbar aria-label="Page navigation example">
                    <ul class="pagination justify-content-center gap-4">
                        {% if fund_investors.has_next %}
                            <li class="page-item">
                                <a class="page-link rounded-3 px-3 py-2" href="?page={{ fund_investors.next_page_number }}&section=section5" aria-label="Next">
                                  <span aria-hidden="true"><i class="fa-solid fa-chevron-right "></i></span>
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                              <span class="page-link rounded-3 px-3 py-2" aria-hidden="true"><i class="fa-solid fa-chevron-right"></i></span>
                            </li>
                        {% endif %}
  
                        {% if fund_investors.has_previous %}
                        <li class="page-item">
                            <a class="page-link rounded-3 px-3 py-2" href="?page={{ fund_investors.previous_page_number }}&section=section5" aria-label="Previous">
                              <span aria-hidden="true"><i class="fa-solid fa-chevron-left"></i></span>
                            </a>
                        </li>
                    {% else %}
  
                        <li class="page-item disabled ">
                          <span class="page-link rounded-3 px-3 py-2" aria-hidden="true"><i class="fa-solid fa-chevron-left"></i></span>
  
                        </li>
                    {% endif %}
                    </ul>
                </navbar> 
              </div>
             
            </div>
           
            
            {%else%}
            <div class="text-center dashboard-section1 d-flex flex-column justify-content-center align-items-center">
              <h3>لا يوجد مستثمرين منضمين حتى الان</h3>
              <p class="text-muted">قم بمشاركة الرمز حتى يتمكن الاعضاء من المشاركة في الصندوق</p>
          </div>
            <div>  </div>
            {%endif%}
          </div>
          <div id="section6" class="container dashboard-section" style="display: none;">
            <div class="container p-0">
                <div class="row justify-content-center">
                    <!-- Wallet Section -->
                    
                </div>
            </div>

            <div class="container p-0">
              <div class="row justify-content-center">
                 <!-- Wallet Card -->
                 <div class="col-md-12">
                  <div class="investment-summary mt-4">
                    <h4>ملخص الصندوق</h4>
                    <p>الاجمالي: <span>ر.س {{ investment_fund.total_balance }}</span></p>
                </div>
                </div>
                
            
               
            
              </div>
            </div>

        </div>
        
      </div>
  </div>
</section>



{%endblock%}
  {%block script%}


  <script>
    const ctx = document.getElementById('fundChart');
    new Chart(ctx, {
      type: 'pie', // Pie chart type
      data: {
        labels: {{ CHlables_fund|safe }}, // Labels (e.g., Total, Profit)
        datasets: [{
          label: '# الرصيد', // Dataset label (optional)
          data: {{ CHdata_fund|safe }}, // Data values (e.g., Total Balance, Profit)
          backgroundColor: [
            'rgba(15, 46, 41, 0.6)', // Green color (first segment)
            'rgba(204, 153, 68, 0.2)'  // Red color (second segment)
          ], // Set green and red as background colors
          borderColor: [
            '#0f2e29',  // Green border
            'rgb(204, 153, 68)',  // Darker yellow

          ], 
          borderWidth: 1 // Border width around each segment
        }]
      },
      options: {
        responsive: true, // Ensure the chart is responsive (scales based on screen size)
        plugins: {
          legend: {
            position: 'top', // Position of the legend (optional)
          },
          tooltip: {
            callbacks: {
              label: function(tooltipItem) {
                // Customize tooltip display if needed
                return tooltipItem.label + ': ' + tooltipItem.raw + ' ر.س'; // Example formatting
              }
            }
          }
        }
      }
    });
  </script>


  <script>
    document.getElementById("shareButton").addEventListener("click", function() {
        var shareText = document.getElementById("unique_code").textContent;

        // Check if Web Share API is available in the browser
        if (navigator.share) {
            navigator.share({
                title: 'Share this Code',
                text: shareText,
                url: window.location.href  // Optionally, add the current page URL
            })
            .then(() => console.log('Code shared successfully!'))
            .catch((error) => console.error('Error sharing code: ', error));
        } else {
            alert("Your browser doesn't support the Web Share API.");
        }
    });
</script>
  <script>
    function copyFunction() {
        // Get the element containing the text you want to copy
        var copyText = document.getElementById("unique_code");

        // Get the text content of the element
        var textToCopy = copyText.textContent || copyText.innerText; // Use textContent for modern browsers

        // Copy the text to the clipboard
        navigator.clipboard.writeText(textToCopy)
    }
</script>

  <script>
    // Handle the section content change
    const navLinks = document.querySelectorAll('.nav-link-dashboard');
    const sections = document.querySelectorAll('.dashboard-section');

    window.onload = function() {
    const urlParams = new URLSearchParams(window.location.search);
    const activeSection = urlParams.get('section');  // الحصول على القسم من معلمة الـ URL

    if (activeSection) {
        document.getElementById(activeSection).classList.add('active');
        document.getElementById(activeSection).style.display = 'block'; // إظهار القسم الافتراضي
        document.querySelector(`.nav-link-dashboard[data-content="${activeSection}"]`).classList.add('active');
        const defaultSection = 'section1'; 
        document.getElementById(defaultSection).style.display = 'none'; 
        document.querySelector(`.nav-link-dashboard[data-content="${defaultSection}"]`).classList.remove('active');

    } else {  
        const defaultSection = 'section1'; 
        document.getElementById(defaultSection).style.display = 'block'; 
        document.querySelector(`.nav-link-dashboard[data-content="${defaultSection}"]`).classList.add('active');
    }
}

    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();

            // Remove the 'active' class from all nav links
            navLinks.forEach(link => link.classList.remove('active'));
            // Add 'active' class to the clicked link
            link.classList.add('active');

            // Hide all sections
            sections.forEach(section => {
                section.style.display = 'none';
            });

            // Show the content corresponding to the clicked section
            const sectionId = link.getAttribute('data-content');
            const activeSection = document.getElementById(sectionId);
            activeSection.style.display = 'block';
        });
    });

</script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Select all elements that should have the date picker
    const dateInputs = document.querySelectorAll('.date-input');  // Add a class to each input you want to apply it to

    // Initialize flatpickr for each selected element
    dateInputs.forEach(function(input) {
        flatpickr(input, {
            dateFormat: "Y-m-d", // Set the date format
            locale: "ar", // Set the locale to Arabic
            maxDate: "today", // Restrict to today's date or earlier
        });
    });
});

</script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

{%endblock%}